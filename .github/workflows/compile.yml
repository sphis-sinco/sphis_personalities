name: Auto-compiled builds (Dekstop)

on:
        push:
                branches-ignore: [randomBranchName]
        pull_request:
                branches-ignore: [randomBranchName]
        workflow_dispatch:

jobs:
        buildLinux:
                runs-on: ubuntu-22.04

                steps:
                        - uses: actions/checkout@main

                        - uses: krdlab/setup-haxe@master
                          with:
                                  haxe-version: 4.3.7

                        - name: Restore Previous Cache
                          id: cache-build-restore
                          uses: actions/cache/restore@main
                          with:
                                  path: |
                                          export/release/linux/haxe/
                                          export/release/linux/obj/
                                  key: cache-build-linux

                        - name: Installing Libraries
                          run: haxe --interp -cp ./actions/libs-installer -D analyzer-optimize -main Main
                        - name: Create Version Tag
                          run: echo "${{github.run_id}}" > VERSION

                        - name: Compile
                          run: haxelib run lime build linux

                        - name: Clear Previous Cache
                          uses: actions/github-script@main
                          with:
                                  script: await require('./actions/cache/clear-cache.js')({github, context}, 'cache-build-linux');

                        - name: Save Current Cache
                          uses: actions/cache@main
                          with:
                                  key: cache-build-linux
                                  path: |
                                          .haxelib/
                                          export/release/linux/haxe/
                                          export/release/linux/obj/
                                  restore-keys: |
                                          cache-build-linux

                        - name: Publish Artifact
                          uses: actions/upload-artifact@main
                          with:
                                  name: linuxBuild
                                  path: export/release/linux/bin
        buildWindows:
                runs-on: windows-latest

                steps:
                        - uses: actions/checkout@main

                        - uses: krdlab/setup-haxe@master
                          with:
                                  haxe-version: 4.3.7

                        - name: Restore Previous Cache
                          id: cache-build-restore
                          uses: actions/cache/restore@main
                          with:
                                  path: |
                                          export/release/windows/haxe/
                                          export/release/windows/obj/
                                  key: cache-build-windows

                        - name: Installing Libraries
                          run: haxe --interp -cp ./actions/libs-installer -D analyzer-optimize -main Main
                        - name: Create Version Tag
                          run: echo "${{github.run_id}}" > VERSION

                        - name: Compile
                          run: haxelib run lime build windows

                        - name: Clear Previous Cache
                          uses: actions/github-script@main
                          with:
                                  script: await require('./actions/cache/clear-cache.js')({github, context}, 'cache-build-windows');

                        - name: Save Current Cache
                          uses: actions/cache@main
                          with:
                                  key: cache-build-windows
                                  path: |
                                          .haxelib/
                                          export/release/windows/haxe/
                                          export/release/windows/obj/
                                  restore-keys: |
                                          cache-build-windows

                        - name: Upload Artifact
                          uses: actions/upload-artifact@main
                          with:
                                  name: windowsBuild
                                  path: export/release/windows/bin
        buildMac:
                runs-on: macos-13

                steps:
                        - uses: actions/checkout@main

                        - uses: krdlab/setup-haxe@master
                          with:
                                  haxe-version: 4.3.7

                        - name: Restore Previous Cache
                          id: cache-build-restore
                          uses: actions/cache/restore@main
                          with:
                                  path: |
                                          export/release/macos/haxe/
                                          export/release/macos/obj/
                                  key: cache-build-mac

                        - name: Installing Libraries
                          run: haxe --interp -cp ./actions/libs-installer -D analyzer-optimize -main Main
                        - name: Create Version Tag
                          run: echo "${{github.run_id}}" > VERSION

                        - name: Compile
                          run: haxelib run lime build mac

                        - name: Clear Previous Cache
                          uses: actions/github-script@main
                          with:
                                  script: await require('./actions/cache/clear-cache.js')({github, context}, 'cache-build-mac');

                        - name: Save Current Cache
                          uses: actions/cache@main
                          with:
                                  key: cache-build-mac
                                  path: |
                                          .haxelib/
                                          export/release/macos/haxe/
                                          export/release/macos/obj/
                                  restore-keys: |
                                          cache-build-mac

                        - name: Publish Artifact
                          uses: actions/upload-artifact@main
                          with:
                                  name: macBuild
                                  path: export/release/macos/bin
        buildHashlink:
                runs-on: windows-latest

                steps:
                        - uses: actions/checkout@main

                        - uses: krdlab/setup-haxe@master
                          with:
                                  haxe-version: 4.3.7

                        - name: Restore Previous Cache
                          id: cache-build-restore
                          uses: actions/cache/restore@main
                          with:
                                  path: |
                                          export/release/hl/haxe/
                                          export/release/hl/obj/
                                  key: cache-build-hl

                        - name: Installing Libraries
                          run: haxe --interp -cp ./actions/libs-installer -D analyzer-optimize -main Main
                        - name: Create Version Tag
                          run: echo "${{github.run_id}}" > VERSION

                        - name: Compile
                          run: haxelib run lime build hl

                        - name: Clear Previous Cache
                          uses: actions/github-script@main
                          with:
                                  script: await require('./actions/cache/clear-cache.js')({github, context}, 'cache-build-hl');

                        - name: Save Current Cache
                          uses: actions/cache@main
                          with:
                                  key: cache-build-hl
                                  path: |
                                          .haxelib/
                                          export/release/hl/haxe/
                                          export/release/hl/obj/
                                  restore-keys: |
                                          cache-build-hl

                        - name: Publish Artifact
                          uses: actions/upload-artifact@main
                          with:
                                  name: hashlinkBuild
                                  path: export/release/hl/bin